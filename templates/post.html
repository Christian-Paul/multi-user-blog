{% extends 'main.html' %}

{% block title %}{{ post.subject }}{% endblock %}

{% block head %}
	{{ super() }}
	<link rel="stylesheet" type="text/css" href="/css/post.css">
{% endblock %}

{% block content %}
	<div class="post-container">
		{% if editing_target == 'post' %}
			<h1 class='main-title'>Edit Post</h1>
			<div class='form-group'>
				<label for='subject'>Subject:</label>
				<input required class='form-control subject-input' type="subject" name="subject" value='{{post.subject}}'>
			</div>

			<div class='form-group {{ "has-error" if error_message }}'>
				<label for='content'>Content:</label>
				<textarea required rows='20' class='content-input form-control' name='content'>{{post.content}}</textarea>
			</div>
			{% if error_message %}
				<div class='alert alert-danger' role='alert'>{{error_message}}</div>
			{% endif %}
			<button class='update-post btn btn-primary'>Update</button>
			<button class='cancel-post-edit btn btn-default'>Cancel</button>
		{% else %}
			<h1 id='post-subject'>{{post.subject}}</h1>
			{% if post.author.username == user.username %}
				<button class='btn btn-primary edit-button'>Edit</button>
				<button class='btn btn-danger delete-button' id='some-id'>Delete</button>
			{% else %}
				<button class='btn btn-default like-button'>
					{% if post.likes %}
						<span class="glyphicon glyphicon-heart" aria-hidden="true"></span>
						<span>You like this!</span>
					{% else %}
						<span class="glyphicon glyphicon-heart-empty" aria-hidden="true"></span>
						<span>Like</span>
					{% endif %}
				</button>
				Likes: {{post.likes|length}}
			{% endif %}	
			<p id='post-content'>{{post.content}}</p>
		{% endif %}
	</div>
	<form method='post' action='{{post.key().id()}}/comment'>
		<h3>Add a Comment</h3>
		<div class='form-group {{ "has-error" if error_message }}'>
			<textarea required rows='10' class='form-control' name='content'>{{content}}</textarea>
		</div>
		{% if error_message %}
			<div class='alert alert-danger' role='alert'>{{error_message}}</div>
		{% endif %}
		<button class='btn btn-primary'>Submit</button>
	</form>
	<div class="comments">
		{% for comment in comments %}
			<div class="comment well" id='{{comment.key().id()}}'>
				<div class="comment-header">
					<h3 class="comment-author">
						{{comment.author.username}}					
					</h4>
					<p class="comment-time">
						{{comment.created.strftime('%Y-%m-%d %H:%M')}}					
					</p>
				</div>
				<p class="comment-content">{{comment.content}}</p>
				{% if comment.author.username == user.username %}
					<div class="comment-settings-default">
						<span class="glyphicon glyphicon-remove delete-comment" aria-hidden="true"></span>
						<span class="glyphicon glyphicon-pencil edit-comment" aria-hidden="true"></span>
					</div>
					<div class="comment-settings-editing hide">
						<button class='update-comment btn btn-primary'>Update</button>
						<button class='cancel-comment-edit btn btn-default'>Cancel</button>
					</div>
				{% endif %}
			</div>
		{% endfor %}
	</div>
	<script type="text/javascript">
		var deleteButton = document.getElementsByClassName('delete-button')[0];
		var deleteComment = document.getElementsByClassName('delete-comment')[0];
		var editComment = document.getElementsByClassName('edit-comment')[0];
		var cancelEditComment = document.getElementsByClassName('cancel-comment-edit')[0];
		var updateComment = document.getElementsByClassName('update-comment')[0];
		var editButton = document.getElementsByClassName('edit-button')[0];
		var likeButton = document.getElementsByClassName('like-button')[0];
		var cancelPostEdit = document.getElementsByClassName('cancel-post-edit')[0];
		var updatePost = document.getElementsByClassName('update-post')[0];
		var defaultCommentSettings = document.getElementsByClassName('comment-settings-default')[0];
		var editingCommentSettings = document.getElementsByClassName('comment-settings-editing')[0];
		var currentUrl = window.location.pathname;

		if(deleteButton) {
			deleteButton.addEventListener('click', function() {
				fetch(currentUrl, {
					method: 'delete'
				})
				.then(function(res) {
					if(res.ok) {
						console.log(res)
						// TODO redirect to user's blog page
					}
				})
			})
		}

		if(editButton) {
			editButton.addEventListener('click', function() {
				window.location.href = currentUrl + '?' + 'editingTarget=post';
			})
		}

		if(cancelPostEdit) {
			cancelPostEdit.addEventListener('click', function() {
				window.location.href = currentUrl.split('?')[0];
			})
		}

		if(updatePost) {
			updatePost.addEventListener('click', function() {
				newSubject = document.getElementsByClassName('subject-input')[0].value;
				newContent = document.getElementsByClassName('content-input')[0].value;

				fetch(currentUrl, {
					method: 'put',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify({
						'subject': newSubject,
						'content': newContent
					})
				})
				.then(function(res) {
					if(res.ok) {
						alert(res)
						console.log(res)
						// TODO redirect to post
					}
				})
			})
		}

		if(likeButton) {
			likeButton.addEventListener('click', function() {
				$.ajax(currentUrl + '/like', {
					method: 'put'
				})
				.done(function(res) {
					if(res) {
						alert(res)
						console.log(res)
						// TODO update likes
					}
				})
			})
		}

		if(deleteComment) {
			deleteComment.addEventListener('click', function() {
				commentId = this.parentElement.parentElement.id;

				$.ajax(currentUrl + '/comment/' + commentId, {
					method: 'delete'
				})
				.done(function(res) {
					if(res) {
						alert(res)
						console.log(res)
						// TODO refresh page
					}
				})
			})
		}

		if(editComment) {
			editComment.addEventListener('click', function() {
				commentId = this.parentElement.parentElement.id;
				commentOld = this.parentElement.previousSibling.previousSibling;
				commentContent = commentOld.textContent;
				defaultCommentSettings.classList.add('hide');
				editingCommentSettings.classList.remove('hide');

				var commentInput = document.createElement('textarea');
				commentInput.classList.add('comment-content');
				commentInput.classList.add('form-control');
				commentInput.appendChild(document.createTextNode(commentContent));
				// make editing comment interface
				commentOld.replaceWith(commentInput)
			})
		}

		if(cancelEditComment) {
			cancelEditComment.addEventListener('click', function() {
				commentId = this.parentElement.parentElement.id;
				commentOld = this.parentElement.previousSibling.previousSibling.previousSibling.previousSibling;
				commentContent = commentOld.value;
				defaultCommentSettings.classList.remove('hide');
				editingCommentSettings.classList.add('hide');

				var commentParagraph = document.createElement('p');
				commentParagraph.classList.add('comment-content');
				commentParagraph.appendChild(document.createTextNode(commentContent));
				// make editing comment interface
				commentOld.replaceWith(commentParagraph)
			})
		}

		if(updateComment) {
			updateComment.addEventListener('click', function() {
				commentId = this.parentElement.parentElement.id;
				commentOld = this.parentElement.previousSibling.previousSibling.previousSibling.previousSibling;
				commentContent = commentOld.value;

				$.ajax(currentUrl + '/comment/' + commentId, {
					method: 'put',
					headers: {'Content-Type': 'application/json'},
					data: JSON.stringify({
						'content': commentContent
					})
				})
				.done(function(res) {
					if(res) {
						alert(res)
						console.log(res)
						// TODO refresh page
					}
				})
			})
		}

	</script>
{% endblock %}